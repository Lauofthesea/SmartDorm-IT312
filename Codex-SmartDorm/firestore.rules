rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isSignedIn() && 
             exists(/databases/$(database)/documents/Admin/$(request.auth.token.email)) &&
             get(/databases/$(database)/documents/Admin/$(request.auth.token.email)).data.role == "admin";
    }
    
    function isTenantOwner(tenantEmail) {
      return isSignedIn() && request.auth.token.email == tenantEmail;
    }
    
    match /Admin/{email} {
      allow read: if isAdmin();
      allow write: if false; // 
    }
    
    match /Users/{email} {
      allow read: if isSignedIn() && (request.auth.token.email == email || isAdmin());
      allow create: if isSignedIn() && request.auth.token.email == email;
      allow update: if isSignedIn() && (request.auth.token.email == email || isAdmin());
      allow delete: if isAdmin();
    }
    
    match /Tenants/{tenantId} {
      allow read: if isSignedIn() && 
                     (isAdmin() || 
                      request.auth.token.email == resource.data.email);
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    match /Rooms/{roomId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    
    match /Bills/{billId} {
      allow read: if isSignedIn() && 
                     (isAdmin() || 
                      request.auth.token.email == resource.data.tenantEmail);
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Tenants can read their own transactions
    // Admins can read/write all
    match /Transactions/{transactionId} {
      allow read: if isSignedIn() && 
                     (isAdmin() || 
                      request.auth.token.email == resource.data.tenantEmail);
      allow create: if isSignedIn(); 
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    match /PaymentIntents/{intentId} {
      allow read: if isSignedIn() && 
                     (isAdmin() || 
                      request.auth.uid == resource.data.userId);
      allow create: if isSignedIn();
      allow update: if isSignedIn() && 
                       (isAdmin() || 
                        request.auth.uid == resource.data.userId);
      allow delete: if isAdmin();
    }
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}